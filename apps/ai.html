<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Orbit AI + Starship Drive</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <script src="https://js.puter.com/v2/"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <style>
    :root {
      --bg: #0d0d14;
      --accent: #8a2be2;
      --neon: #ae54ff;
      --text: #eee;
    }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: 'Inter', sans-serif; display: flex; flex-direction: column; height: 100vh;
    }
    
    /* Header & Cloud Status */
    .chat-header {
      padding: 15px 25px; background: rgba(255,255,255,0.03);
      display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid rgba(138, 43, 226, 0.2);
    }
    .logo { display: flex; align-items: center; gap: 10px; font-weight: 800; letter-spacing: 2px; }
    .logo img { width: 30px; height: 30px; border-radius: 50%; box-shadow: 0 0 10px var(--accent); }
    
    #syncStatus { font-size: 10px; color: #aaa; text-transform: uppercase; display: flex; align-items: center; gap: 5px; }
    .syncing-icon { animation: spin 2s linear infinite; display: none; }
    @keyframes spin { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }

    /* Messages Area */
    #chat { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .msg { max-width: 80%; padding: 12px 18px; border-radius: 15px; line-height: 1.5; }
    .user { align-self: flex-end; background: var(--accent); color: white; }
    .ai { align-self: flex-start; background: rgba(255,255,255,0.05); border: 1px solid rgba(138, 43, 226, 0.2); }

    /* Input Box */
    .input-area { padding: 20px; display: flex; gap: 10px; background: #08080c; }
    input { flex-grow: 1; background: #161625; border: 1px solid #333; border-radius: 25px; padding: 12px 20px; color: white; outline: none; }
    input:focus { border-color: var(--neon); }
    button { background: var(--accent); border: none; color: white; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; }
  </style>
</head>
<body>

<div class="chat-header">
  <div class="logo">
    <img src="/uploads/images/starbot.png" alt="Orbit">
    ORBIT <span style="color:var(--neon); font-size:10px;">PRO CLOUD</span>
  </div>
  <div id="syncStatus">
    <i class="fa-solid fa-arrows-rotate syncing-icon" id="syncIcon"></i>
    <span id="statusText">Cloud Standby</span>
  </div>
</div>

<div id="chat">
  <div class="msg ai">Greetings. I am Orbit. I am connected to your Google Drive for automatic session backups.</div>
</div>

<div class="input-area">
  <input type="text" id="userInput" placeholder="Ask Orbit anything...">
  <button onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
</div>

<script>
  // GOOGLE DRIVE CLIENT ID
  const CLIENT_ID = '106130595767-2ai0d8mac2ard8q2ngthuuh5pahoutuv.apps.googleusercontent.com';
  
  // 1. Send Message Logic
  async function sendMessage() {
    const input = document.getElementById('userInput');
    const chat = document.getElementById('chat');
    if (!input.value.trim()) return;

    const userText = input.value;
    chat.innerHTML += `<div class="msg user">${userText}</div>`;
    input.value = '';

    try {
      // Using Puter AI as requested in your original ai.html
      const response = await puter.ai.chat(userText);
      const cleanResponse = DOMPurify.sanitize(marked.parse(response));
      chat.innerHTML += `<div class="msg ai">${cleanResponse}</div>`;
      chat.scrollTop = chat.scrollHeight;
    } catch (err) {
      chat.innerHTML += `<div class="msg ai" style="color:red">Connection to Orbit Kernel Interrupted.</div>`;
    }
  }

  // 2. Google Drive Auto-Save Logic
  async function autoSaveToDrive() {
    const token = window.parent.DRIVE_ACCESS_TOKEN; // Gets token from Zenith OS Parent
    if (!token) {
        document.getElementById('statusText').innerText = "Drive Not Connected";
        return;
    }

    // Show syncing animation
    document.getElementById('syncIcon').style.display = 'inline-block';
    document.getElementById('statusText').innerText = "Syncing...";

    const chatData = document.getElementById('chat').innerText;
    const metadata = {
      name: `Orbit_Backup_${new Date().toLocaleDateString()}.txt`,
      mimeType: 'text/plain'
    };

    const formData = new FormData();
    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    formData.append('file', new Blob([chatData], { type: 'text/plain' }));

    try {
      const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: formData
      });

      if (resp.ok) {
        document.getElementById('statusText').innerText = "Cloud Synced";
      } else {
        document.getElementById('statusText').innerText = "Sync Failed";
      }
    } catch (e) {
      document.getElementById('statusText').innerText = "Network Error";
    } finally {
      document.getElementById('syncIcon').style.display = 'none';
    }
  }

  // 3. Set Auto-Save Interval (Every 5 minutes)
  setInterval(autoSaveToDrive, 300000);

  // Allow Enter key to send
  document.getElementById('userInput').addEventListener('keypress', (e) => {
    if(e.key === 'Enter') sendMessage();
  });
</script>

</body>
</html>
