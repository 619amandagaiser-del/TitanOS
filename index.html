<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowV5 | Living OS</title>
    <script src="https://js.puter.com/v2/" defer></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-image: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072&auto=format&fit=crop');
            --accent: #3b82f6; 
            --win-bg: #0f172a; 
            --text: #e2e8f0;
        }

        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; overflow: hidden; height: 100vh; font-family: 'Inter', sans-serif; color: var(--text); background: #000; }

        /* Wallpaper Layer */
        #wallpaper {
            position: absolute; inset: 0; background: var(--bg-image) no-repeat center center/cover;
            z-index: -1; transition: background 0.5s;
        }
        #wallpaper::after { content: ""; position: absolute; inset: 0; background: rgba(0,0,0,0.2); backdrop-filter: blur(0px); }

        /* Desktop Grid */
        #desktop {
            height: calc(100vh - 48px); display: flex; flex-direction: column; flex-wrap: wrap; 
            align-content: flex-start; padding: 15px; gap: 15px;
        }

        .icon {
            width: 80px; display: flex; flex-direction: column; align-items: center; cursor: pointer;
            padding: 10px; border-radius: 8px; transition: 0.2s; text-shadow: 0 2px 5px black;
        }
        .icon:hover { background: rgba(255,255,255,0.1); }
        .icon i { font-size: 36px; margin-bottom: 5px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.5)); }
        .icon span { font-size: 11px; font-weight: 600; text-align: center; }

        /* Window System */
        .window {
            position: absolute; background: var(--win-bg); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px; box-shadow: 0 25px 50px rgba(0,0,0,0.6); display: flex; flex-direction: column;
            overflow: hidden; min-width: 300px; min-height: 200px;
            animation: popIn 0.2s cubic-bezier(0,1,0.5,1);
        }
        @keyframes popIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .win-bar {
            height: 36px; background: rgba(30, 41, 59, 0.9); display: flex; align-items: center;
            justify-content: space-between; padding: 0 10px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .win-title { font-size: 12px; font-weight: bold; flex-grow: 1; padding-left: 10px; }
        .win-controls button { width: 12px; height: 12px; border-radius: 50%; border: none; margin-left: 6px; cursor: pointer; }
        
        .content { flex-grow: 1; position: relative; background: #1e293b; overflow: hidden; }
        iframe { width: 100%; height: 100%; border: none; background: white; }

        /* Apps UI */
        .terminal { background: #0c0c0c; color: #22c55e; font-family: 'JetBrains Mono'; padding: 10px; height: 100%; font-size: 13px; overflow-y: auto; }
        .input-line { display: flex; margin-top: 5px; }
        .cmd-in { background: transparent; border: none; color: inherit; font-family: inherit; flex-grow: 1; outline: none; }
        
        .notepad { display: flex; flex-direction: column; height: 100%; }
        .notepad textarea { flex-grow: 1; background: #1e293b; color: white; border: none; padding: 15px; resize: none; outline: none; font-family: 'JetBrains Mono'; }
        .notepad-toolbar { padding: 5px; background: #0f172a; border-bottom: 1px solid #333; display: flex; gap: 10px; }
        .btn-small { background: var(--accent); border: none; color: white; padding: 4px 10px; font-size: 11px; border-radius: 4px; cursor: pointer; }

        .settings-panel { padding: 20px; color: white; }
        .setting-row { margin-bottom: 15px; }
        .setting-row label { display: block; font-size: 12px; margin-bottom: 5px; color: #94a3b8; }
        .setting-row input { width: 100%; padding: 8px; background: #0f172a; border: 1px solid #333; color: white; border-radius: 4px; }

        /* Taskbar */
        #taskbar {
            position: absolute; bottom: 0; width: 100%; height: 48px;
            background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; padding: 0 10px;
            z-index: 9999;
        }
        .start-btn { 
            background: var(--accent); color: white; border: none; padding: 6px 14px; border-radius: 6px; 
            font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; 
        }

        /* Start Menu */
        #start-menu {
            position: absolute; bottom: 55px; left: 10px; width: 320px; background: #0f172a;
            border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px;
            display: none; box-shadow: 0 0 30px rgba(0,0,0,0.5); z-index: 10000;
        }

        /* Resize Handle */
        .resizer { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: se-resize; }
    </style>
</head>
<body onload="OS.init()">

    <div id="wallpaper"></div>
    
    <div id="desktop"></div>

    <div id="start-menu">
        <h3 style="margin: 0 0 15px 0;">Shadow<span style="color:var(--accent)">OS</span></h3>
        <input type="text" placeholder="Search..." style="width:100%; padding:8px; background:#1e293b; border:1px solid #333; color:white; border-radius:4px; margin-bottom:10px;">
        <div style="font-size:12px; color:#64748b; margin-top:10px;">User: Administrator</div>
        <button onclick="window.location.reload()" style="margin-top:10px; width:100%; padding:8px; background:#ef4444; border:none; color:white; border-radius:4px; cursor:pointer;">Restart System</button>
    </div>

    <div id="taskbar">
        <button class="start-btn" onclick="OS.toggleStart()">
            <i class="material-icons-round" style="font-size:18px;">grid_view</i> Start
        </button>
        <div style="flex-grow:1;"></div>
        <div id="clock" style="font-family:'JetBrains Mono'; font-size:12px; padding:0 15px;">00:00</div>
    </div>

    <script>
        // --- STORAGE SYSTEM (Persistent) ---
        const Drive = {
            save: (key, val) => localStorage.setItem('shadow_' + key, val),
            load: (key) => localStorage.getItem('shadow_' + key),
            getFiles: () => JSON.parse(localStorage.getItem('shadow_files') || '{}'),
            saveFile: (name, content) => {
                const files = Drive.getFiles();
                files[name] = content;
                localStorage.setItem('shadow_files', JSON.stringify(files));
            }
        };

        // --- APP REGISTRY ---
        const Apps = {
            'browser': { name: 'Chrome', icon: 'public', color: '#2563eb', type: 'iframe', src: 'https://google.com/webhp?igu=1' },
            'games': { name: 'Games', icon: 'sports_esports', color: '#f59e0b', type: 'iframe', src: 'https://ubg365.github.io/' },
            'notepad': { name: 'Notepad', icon: 'edit_note', color: '#10b981', type: 'custom', render: (id) => OS.renderNotepad(id) },
            'terminal': { name: 'Terminal', icon: 'terminal', color: '#000000', type: 'custom', render: (id) => OS.renderTerminal(id) },
            'settings': { name: 'Settings', icon: 'settings', color: '#64748b', type: 'custom', render: (id) => OS.renderSettings(id) },
            'files': { name: 'Files', icon: 'folder', color: '#eab308', type: 'custom', render: (id) => OS.renderFiles(id) },
            'ai': { name: 'ChatGPT', icon: 'smart_toy', color: '#14b8a6', type: 'iframe', src: 'https://chatgpt.com' }
        };

        // --- OPERATING SYSTEM ---
        const OS = {
            zIndex: 100,
            
            init() {
                this.renderDesktop();
                this.loadTheme();
                setInterval(this.updateClock, 1000);
                
                // Keyboard Shortcuts
                document.addEventListener('keydown', e => {
                    if(e.key === "Escape") window.location.href = "http://myapps.classlink.com";
                });
            },

            loadTheme() {
                const bg = Drive.load('bg');
                const accent = Drive.load('accent');
                if(bg) document.documentElement.style.setProperty('--bg-image', `url(${bg})`);
                if(accent) document.documentElement.style.setProperty('--accent', accent);
            },

            updateClock() {
                const d = new Date();
                document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            },

            renderDesktop() {
                const d = document.getElementById('desktop');
                Object.keys(Apps).forEach(key => {
                    const app = Apps[key];
                    const div = document.createElement('div');
                    div.className = 'icon';
                    div.innerHTML = `<i class="material-icons-round" style="color:${app.color}">${app.icon}</i><span>${app.name}</span>`;
                    div.onclick = () => this.openWindow(key);
                    d.appendChild(div);
                });
            },

            toggleStart() {
                const m = document.getElementById('start-menu');
                m.style.display = m.style.display === 'block' ? 'none' : 'block';
            },

            openWindow(appKey) {
                const app = Apps[appKey];
                const id = 'win_' + Date.now();
                const win = document.createElement('div');
                win.className = 'window';
                win.id = id;
                win.style.width = '600px'; win.style.height = '400px';
                win.style.left = '50px'; win.style.top = '50px';
                win.style.zIndex = ++this.zIndex;

                let contentHTML = '';
                if(app.type === 'iframe') {
                    // Smart Proxy Injection
                    contentHTML = `<iframe src="${app.src}"></iframe>`;
                    if(!app.src.includes('google')) {
                         // Attempt Puter fetch in background, fallback to src
                         puter.net.fetch(app.src).then(r=>r.blob()).then(b=>{
                             const url = URL.createObjectURL(b);
                             const f = document.querySelector(`#${id} iframe`);
                             if(f) f.src = url;
                         }).catch(e=>console.log('Direct load'));
                    }
                } else {
                    contentHTML = app.render(id);
                }

                win.innerHTML = `
                    <div class="win-bar" onmousedown="OS.dragStart(event, '${id}')">
                        <i class="material-icons-round" style="font-size:16px; color:${app.color}">${app.icon}</i>
                        <span class="win-title">${app.name}</span>
                        <div class="win-controls">
                            <button onclick="document.getElementById('${id}').remove()" style="background:#ef4444"></button>
                            <button onclick="OS.maximize('${id}')" style="background:#22c55e"></button>
                        </div>
                    </div>
                    <div class="content" id="content_${id}">${contentHTML}</div>
                    <div class="resizer" onmousedown="OS.resizeStart(event, '${id}')"></div>
                `;

                win.onmousedown = () => win.style.zIndex = ++this.zIndex;
                document.body.appendChild(win);
                document.getElementById('start-menu').style.display = 'none';
            },

            // --- CUSTOM APP LOGIC ---
            
            renderNotepad(id) {
                return `
                    <div class="notepad">
                        <div class="notepad-toolbar">
                            <button class="btn-small" onclick="OS.saveNote('${id}')">Save</button>
                            <input type="text" id="name_${id}" placeholder="filename.txt" style="background:#1e293b; border:1px solid #444; color:white; padding:2px 5px;">
                        </div>
                        <textarea id="text_${id}" placeholder="Type here..."></textarea>
                    </div>`;
            },

            saveNote(id) {
                const name = document.getElementById(`name_${id}`).value || 'untitled.txt';
                const text = document.getElementById(`text_${id}`).value;
                Drive.saveFile(name, text);
                alert(`Saved ${name} to System Drive.`);
            },

            renderSettings(id) {
                return `
                    <div class="settings-panel">
                        <h3>System Customization</h3>
                        <div class="setting-row">
                            <label>Wallpaper URL</label>
                            <input type="text" id="bg_${id}" placeholder="https://..." onchange="OS.applySetting('bg', this.value)">
                        </div>
                        <div class="setting-row">
                            <label>Accent Color (Hex)</label>
                            <input type="color" id="acc_${id}" value="#3b82f6" onchange="OS.applySetting('accent', this.value)">
                        </div>
                        <p style="font-size:10px; color:#64748b">Changes save automatically.</p>
                    </div>`;
            },

            applySetting(key, val) {
                if(key === 'bg') document.documentElement.style.setProperty('--bg-image', `url(${val})`);
                if(key === 'accent') document.documentElement.style.setProperty('--accent', val);
                Drive.save(key, val);
            },

            renderFiles(id) {
                const files = Drive.getFiles();
                let html = '<div style="padding:20px; display:grid; grid-template-columns:repeat(4,1fr); gap:10px;">';
                if(Object.keys(files).length === 0) return '<div style="padding:20px; color:#94a3b8">Disk is empty. Create files in Notepad.</div>';
                
                Object.keys(files).forEach(f => {
                    html += `
                        <div style="text-align:center; cursor:pointer;" onclick="alert('Content: \\n' + '${files[f].replace(/\n/g, "\\n")}')">
                            <i class="material-icons-round" style="font-size:40px; color:#eab308">description</i>
                            <div style="font-size:12px; margin-top:5px;">${f}</div>
                        </div>`;
                });
                return html + '</div>';
            },

            renderTerminal(id) {
                setTimeout(() => this.termLog(id, "ShadowOS Kernel v5.0 Loaded... Type 'help'"), 100);
                return `<div class="terminal" id="term_${id}" onclick="document.getElementById('in_${id}').focus()">
                            <div id="output_${id}"></div>
                            <div class="input-line">
                                <span style="color:#22c55e; margin-right:10px;">root@shadow:~#</span>
                                <input type="text" id="in_${id}" class="cmd-in" autocomplete="off" onkeypress="if(event.key==='Enter') OS.handleCmd('${id}', this)">
                            </div>
                        </div>`;
            },

            termLog(id, msg) {
                const out = document.getElementById(`output_${id}`);
                if(out) out.innerHTML += `<div>${msg}</div>`;
            },

            handleCmd(id, input) {
                const cmd = input.value.trim().toLowerCase();
                this.termLog(id, `<span style="color:white">root@shadow:~# ${cmd}</span>`);
                input.value = '';

                if(cmd === 'help') this.termLog(id, "Commands: help, clear, date, reboot, ls, whoami");
                else if(cmd === 'clear') document.getElementById(`output_${id}`).innerHTML = '';
                else if(cmd === 'date') this.termLog(id, new Date().toString());
                else if(cmd === 'reboot') location.reload();
                else if(cmd === 'ls') this.termLog(id, Object.keys(Drive.getFiles()).join('  ') || 'No files');
                else if(cmd === 'whoami') this.termLog(id, 'root (System Administrator)');
                else if(cmd !== '') this.termLog(id, `Command not found: ${cmd}`);
                
                const term = document.getElementById(`term_${id}`);
                term.scrollTop = term.scrollHeight;
            },

            // --- WINDOW MANAGEMENT (Drag/Resize) ---
            maximize(id) {
                const w = document.getElementById(id);
                if(w.style.width === '100%') {
                    w.style.width = '600px'; w.style.height = '400px'; w.style.top='50px'; w.style.left='50px';
                } else {
                    w.style.width='100%'; w.style.height='calc(100vh - 48px)'; w.style.top='0'; w.style.left='0';
                }
            },

            dragStart(e, id) {
                if(e.target.tagName === 'BUTTON') return;
                const win = document.getElementById(id);
                let shiftX = e.clientX - win.getBoundingClientRect().left;
                let shiftY = e.clientY - win.getBoundingClientRect().top;
                const moveAt = (px, py) => { win.style.left = px - shiftX + 'px'; win.style.top = py - shiftY + 'px'; };
                const onMove = (ev) => moveAt(ev.pageX, ev.pageY);
                document.addEventListener('mousemove', onMove);
                document.onmouseup = () => { document.removeEventListener('mousemove', onMove); document.onmouseup = null; };
            },

            resizeStart(e, id) {
                e.stopPropagation();
                const win = document.getElementById(id);
                const startX = e.clientX, startY = e.clientY;
                const startW = parseInt(getComputedStyle(win).width), startH = parseInt(getComputedStyle(win).height);
                const doDrag = (ev) => { win.style.width = (startW + ev.clientX - startX) + 'px'; win.style.height = (startH + ev.clientY - startY) + 'px'; };
                const stopDrag = () => { document.documentElement.removeEventListener('mousemove', doDrag); document.documentElement.removeEventListener('mouseup', stopDrag); };
                document.documentElement.addEventListener('mousemove', doDrag);
                document.documentElement.addEventListener('mouseup', stopDrag);
            }
        };
    </script>
</body>
</html>
