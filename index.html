<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Zenith OS | Media Master Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <style>
        :root { --neon: #ae54ff; --bg: #050505; }
        body, html { margin: 0; padding: 0; height: 100vh; overflow: hidden; background: var(--bg); color: #fff; font-family: 'Inter', sans-serif; }
        #desktop { position: absolute; inset: 0; background: radial-gradient(circle at 50% 50%, #1a0033 0%, #050505 100%); z-index: 1; display: none; }
        #auth-gate { position: fixed; inset: 0; z-index: 99999; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .window { position: absolute; background: rgba(13, 13, 20, 0.98); backdrop-filter: blur(20px); border: 1px solid rgba(138, 43, 226, 0.3); border-radius: 12px; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.8); overflow: hidden; }
        .win-bar { height: 35px; background: rgba(255,255,255,0.05); display: flex; align-items: center; padding: 0 12px; cursor: grab; }
        #dock { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 10px; display: flex; gap: 10px; z-index: 999; }
        .dock-item { width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="auth-gate">
        <h1 class="text-2xl font-black tracking-[15px] mb-2 text-white">ZENITH</h1>
        <p class="text-[10px] text-purple-500 tracking-[5px] uppercase mb-10">Satellite Media OS</p>
        
        <div id="g_id_onload"
             data-client_id="106130595767-hlvoakq65984eu1fc9mq0h3951oll8qs.apps.googleusercontent.com"
             data-callback="onSignIn"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin" data-type="standard" data-shape="pill" data-theme="filled_blue"></div>

        <button id="manual-btn" onclick="Kernel.boot()" class="mt-8 text-[9px] text-gray-500 border border-gray-800 px-4 py-2 rounded-full hover:bg-white hover:text-black transition opacity-50">
            ENTER OS MANUALLY
        </button>
    </div>

    <div id="desktop">
        <div id="dock">
            <div class="dock-item" onclick="Kernel.open('files')"><i class="material-icons-round text-yellow-400">folder</i></div>
            <div class="dock-item" onclick="Kernel.open('tv')"><i class="material-icons-round text-blue-400">movie</i></div>
        </div>
    </div>

    <script>
        // GLOBAL CALLBACK (Must be outside the Kernel object to work)
        window.onSignIn = function(response) {
            console.log("Google Auth Success");
            document.getElementById('manual-btn').classList.remove('opacity-50');
            document.getElementById('manual-btn').innerText = "ACCESS GRANTED: ENTER OS";
            Kernel.boot();
            
            // Get Drive Token
            try {
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: '106130595767-hlvoakq65984eu1fc9mq0h3951oll8qs.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/drive.readonly',
                    callback: (t) => { Kernel.token = t.access_token; }
                });
                client.requestAccessToken({prompt: ''});
            } catch(e) { console.error("Drive token failed", e); }
        };

        const Kernel = {
            z: 100,
            token: null,
            playlist: [],

            boot() {
                document.getElementById('auth-gate').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('auth-gate').style.display = 'none';
                    document.getElementById('desktop').style.display = 'block';
                }, 500);
                try { gapi.load('picker'); } catch(e) {}
            },

            open(type) {
                if(document.getElementById('win-' + type)) return;
                const win = document.createElement('div');
                win.className = 'window';
                win.id = 'win-' + type;
                win.style.width = type === 'tv' ? '850px' : '450px';
                win.style.height = '500px';
                win.style.top = '100px'; win.style.left = '100px';
                win.style.zIndex = ++this.z;

                let html = (type === 'files') ? this.getFilesUI() : this.getTVUI();

                win.innerHTML = `
                    <div class="win-bar"><span class="flex-grow text-[10px] font-bold tracking-widest">${type.toUpperCase()}</span>
                    <span onclick="this.closest('.window').remove()" class="cursor-pointer text-red-500 font-bold">âœ•</span></div>
                    <div style="flex-grow:1;"><iframe id="frame-${type}" srcdoc="${html.replace(/"/g, '&quot;')}" style="width:100%; height:100%; border:none;"></iframe></div>
                `;
                document.getElementById('desktop').appendChild(win);
                if(type === 'tv') setTimeout(() => this.sync(), 500);
            },

            getFilesUI() {
                return `<html><head><script src="https://cdn.tailwindcss.com"></script></head>
                <body class="bg-[#0d0d14] text-white p-4 font-sans text-sm">
                    <input id="s" placeholder="Series Name" class="w-full bg-white/5 p-2 rounded border border-white/10 mb-2">
                    <button onclick="parent.Kernel.pick(window)" class="w-full bg-purple-600 p-2 rounded font-bold uppercase text-[10px]">Select Folder</button>
                    <div id="out" class="mt-4 space-y-1"></div>
                </body></html>`;
            },

            getTVUI() {
                return `<html><head><script src="https://cdn.tailwindcss.com"></script></head>
                <body class="bg-black text-white h-screen flex flex-col overflow-hidden">
                    <div class="flex-grow bg-[#050505] flex items-center justify-center">
                        <iframe id="vid" class="w-full h-full" style="display:none;" allow="autoplay; fullscreen"></iframe>
                        <div id="msg" class="text-gray-800 font-bold">NO MEDIA LOADED</div>
                    </div>
                    <div id="list" class="h-24 bg-[#0d0d14] p-2 flex gap-2 overflow-x-auto"></div>
                </body></html>`;
            },

            pick(child) {
                if(!this.token) { alert("Drive not connected. Try logging in again."); return; }
                const name = child.document.getElementById('s').value || "Series";
                const picker = new google.picker.PickerBuilder()
                    .setAppId('106130595767').setOAuthToken(this.token).setDeveloperKey('AIzaSyDQmlHngYNWqAbveDkUCiuIdgN1ZnnZ2ng')
                    .addView(new google.picker.DocsView(google.picker.ViewId.FOLDERS))
                    .setCallback(async (data) => {
                        if (data.action == google.picker.Action.PICKED) {
                            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${data.docs[0].id}'+in+parents&fields=files(id,name,mimeType)&key=AIzaSyDQmlHngYNWqAbveDkUCiuIdgN1ZnnZ2ng`, {
                                headers: { 'Authorization': 'Bearer ' + this.token }
                            });
                            const json = await res.json();
                            this.playlist = json.files.filter(f => f.mimeType.includes('video'))
                                .sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true}))
                                .map(f => ({ id: f.id, name: f.name, show: name }));
                            child.document.getElementById('out').innerHTML = `<p class='text-green-500'>${this.playlist.length} Episodes Ready</p>`;
                            this.sync();
                        }
                    }).build();
                picker.setVisible(true);
            },

            sync() {
                const f = document.getElementById('frame-tv'); if(!f) return;
                const doc = f.contentWindow.document;
                const list = doc.getElementById('list'); list.innerHTML = "";
                this.playlist.forEach((ep, i) => {
                    const div = doc.createElement('div');
                    div.className = "min-w-[120px] bg-white/5 p-2 rounded border border-white/10 cursor-pointer text-[10px]";
                    div.innerHTML = `<b>EP ${i+1}</b><br><span class='opacity-50 truncate'>${ep.name}</span>`;
                    div.onclick = () => {
                        doc.getElementById('msg').style.display = 'none';
                        doc.getElementById('vid').src = `https://drive.google.com/file/d/${ep.id}/preview`;
                        doc.getElementById('vid').style.display = 'block';
                    };
                    list.appendChild(div);
                });
            }
        };
    </script>
</body>
</html>
