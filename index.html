<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowOS | Ultimate</title>
    <script src="https://js.puter.com/v2/" defer></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2072');
            --accent: #3b82f6; --win-bg: #0f172a; --text: #e2e8f0;
        }
        * { box-sizing: border-box; user-select: none; }
        body { margin: 0; overflow: hidden; height: 100vh; font-family: 'Inter', sans-serif; color: var(--text); background: #000; }
        #wallpaper { position: absolute; inset: 0; background: var(--bg) no-repeat center center/cover; z-index: -1; filter: brightness(0.3); }

        #desktop { height: calc(100vh - 48px); display: flex; flex-direction: column; flex-wrap: wrap; align-content: flex-start; padding: 20px; gap: 20px; }
        .icon { width: 85px; display: flex; flex-direction: column; align-items: center; cursor: pointer; text-shadow: 0 2px 5px black; }
        .icon i { font-size: 40px; margin-bottom: 5px; color: var(--accent); }
        .icon span { font-size: 10px; font-weight: 900; text-align: center; letter-spacing: 1px; }

        .window { position: absolute; background: var(--win-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; box-shadow: 0 25px 50px rgba(0,0,0,0.8); display: flex; flex-direction: column; overflow: hidden; }
        .win-bar { height: 40px; background: rgba(30, 41, 59, 0.95); display: flex; align-items: center; padding: 0 15px; cursor: move; }
        .win-title { font-size: 10px; font-weight: 900; flex-grow: 1; letter-spacing: 2px; }
        .win-controls { display: flex; gap: 8px; }
        .win-btn { width: 12px; height: 12px; border-radius: 50%; border: none; cursor: pointer; }

        .content { flex-grow: 1; position: relative; overflow: hidden; background: #fff; }
        iframe { width: 100%; height: 100%; border: none; }
        
        .browser-nav { padding: 10px; background: #1e293b; display: flex; gap: 10px; align-items: center; }
        .url-box { flex-grow: 1; background: #0f172a; border: 1px solid #333; color: white; padding: 8px 15px; border-radius: 20px; outline: none; font-family: 'JetBrains Mono'; font-size: 11px; }

        #taskbar { position: absolute; bottom: 0; width: 100%; height: 48px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; padding: 0 20px; z-index: 10000; }
        .tray { display: flex; align-items: center; gap: 15px; margin-left: auto; font-family: 'JetBrains Mono'; font-size: 12px; color: #94a3b8; }
    </style>
</head>
<body onload="OS.init()">

    <div id="wallpaper"></div>
    <div id="desktop"></div>

    <div id="taskbar">
        <div style="font-weight: 900; letter-spacing: 2px;">SHADOW<span style="color:var(--accent)">V8.6</span></div>
        <div class="tray">
            <div id="clock">00:00</div>
        </div>
    </div>

    <script>
        const OS = {
            zIndex: 100,
            init() {
                this.renderDesktop();
                setInterval(() => {
                    document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                }, 1000);
                document.addEventListener('keydown', e => { if(e.key === "Escape") location.href='https://google.com'; });
            },

            cloak() {
                const win = window.open('about:blank', '_blank');
                const doc = win.document;
                doc.title = "about:blank";
                const iframe = doc.createElement('iframe');
                iframe.style = "position:fixed; top:0; left:0; width:100%; height:100%; border:none;";
                iframe.src = window.location.href;
                doc.body.appendChild(iframe);
                window.location.replace('https://google.com');
            },

            renderDesktop() {
                const apps = [
                    { id: 'cloak', name: 'Cloak', icon: 'visibility_off' },
                    { id: 'browser', name: 'Browser', icon: 'public' },
                    { id: 'notepad', name: 'Notepad', icon: 'edit' }
                ];
                const d = document.getElementById('desktop');
                apps.forEach(app => {
                    const div = document.createElement('div');
                    div.className = 'icon';
                    div.innerHTML = `<i class="material-icons-round">${app.icon}</i><span>${app.name.toUpperCase()}</span>`;
                    div.onclick = () => app.id === 'cloak' ? this.cloak() : this.openWindow(app);
                    d.appendChild(div);
                });
            },

            openWindow(app) {
                const id = 'win_' + Date.now();
                const win = document.createElement('div');
                win.className = 'window'; win.id = id;
                win.style.width = '900px'; win.style.height = '600px';
                win.style.left = '50px'; win.style.top = '50px';
                win.style.zIndex = ++this.zIndex;

                let inner = '';
                if(app.id === 'browser') {
                    inner = `
                        <div style="display:flex; flex-direction:column; height:100%;">
                            <div class="browser-nav">
                                <input type="text" id="url_${id}" class="url-box" placeholder="Enter URL..." onkeypress="if(event.key==='Enter') OS.navigate('${id}')">
                                <button onclick="OS.exportCode('${id}')" style="background:#444; color:white; border:none; padding:5px 10px; border-radius:5px; font-size:10px; cursor:pointer;">GET CODE</button>
                            </div>
                            <iframe id="frame_${id}" src="about:blank"></iframe>
                        </div>`;
                } else if(app.id === 'notepad') {
                    inner = `<textarea id="note_${id}" style="width:100%; height:100%; background:#0f172a; color:white; border:none; padding:20px; outline:none; font-family:'JetBrains Mono'; resize:none;" oninput="localStorage.setItem('sh_note', this.value)">${localStorage.getItem('sh_note')||''}</textarea>`;
                }

                win.innerHTML = `<div class="win-bar" onmousedown="OS.dragStart(event, '${id}')"><div class="win-title">${app.name.toUpperCase()}</div><div class="win-controls"><button class="win-btn" style="background:#ef4444" onclick="document.getElementById('${id}').remove()"></button></div></div><div class="content">${inner}</div>`;
                document.body.appendChild(win);
            },

            async navigate(winId) {
                const input = document.getElementById(`url_${winId}`);
                const frame = document.getElementById(`frame_${winId}`);
                let url = input.value;
                if(!url.includes('.') || url.includes(' ')) url = `https://www.google.com/search?q=${encodeURIComponent(url)}&igu=1`;
                else if(!url.startsWith('http')) url = 'https://' + url;

                // Stealth scramble for address bar
                const realTarget = url;
                input.value = "sys_render_" + btoa(url).substring(0, 8) + ".tmp";

                // The Fix: Fetch content and manually inject it into the iframe as HTML
                try {
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(realTarget)}`);
                    const data = await response.json();
                    
                    // This is the "Renderer" - it takes the raw code and forces it to display as a webpage
                    const doc = frame.contentWindow.document;
                    doc.open();
                    doc.write(data.contents);
                    doc.close();

                    // Fix links and images that might be broken due to proxy
                    const base = doc.createElement('base');
                    base.href = realTarget;
                    doc.head.appendChild(base);
                } catch (e) {
                    frame.src = realTarget; // Fallback to direct load
                }
            },

            async exportCode(winId) {
                const frame = document.getElementById(`frame_${winId}`);
                const code = frame.contentWindow.document.documentElement.outerHTML;
                localStorage.setItem('sh_note', code);
                alert("Website code has been exported to your Notepad!");
            },

            dragStart(e, id) {
                const win = document.getElementById(id);
                let x = e.clientX - win.offsetLeft, y = e.clientY - win.offsetTop;
                const move = (ev) => { win.style.left = ev.clientX - x + 'px'; win.style.top = ev.clientY - y + 'px'; };
                document.addEventListener('mousemove', move);
                document.onmouseup = () => document.removeEventListener('mousemove', move);
            }
        };
    </script>
</body>
</html>
