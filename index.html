<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titan OS | Unified</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
    
    <style>
        :root { --cyan: #00f2ff; --bg: #020205; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { 
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            overflow: hidden; background: var(--bg); color: #fff; 
            font-family: 'Inter', system-ui, sans-serif; touch-action: none; 
        }
        
        #desktop { 
            position: absolute; inset: 0; 
            background: radial-gradient(circle at 50% 50%, #001a1a 0%, #020205 100%); 
            z-index: 1; transition: opacity 0.6s ease;
        }

        .window { 
            position: absolute; background: rgba(13, 13, 20, 0.98); 
            backdrop-filter: blur(20px); border: 1px solid rgba(0, 242, 255, 0.25); 
            border-radius: 16px; display: flex; flex-direction: column; 
            box-shadow: 0 25px 60px rgba(0,0,0,0.9); z-index: 10;
            overflow: hidden; animation: scaleUp 0.2s ease-out;
        }

        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .win-bar { 
            height: 48px; background: rgba(255,255,255,0.03); 
            display: flex; align-items: center; padding: 0 16px; 
            cursor: grab; border-bottom: 1px solid rgba(255,255,255,0.08);
            user-select: none;
        }

        #dock { 
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); 
            background: rgba(255, 255, 255, 0.08); backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 24px; padding: 12px 24px; display: flex; gap: 24px; z-index: 999; 
            transition: 0.5s ease;
        }
        
        .dock-item { 
            width: 52px; height: 52px; display: flex; align-items: center; 
            justify-content: center; cursor: pointer; transition: 0.3s; border-radius: 14px; 
        }
        .dock-item:active { transform: scale(0.9); background: rgba(0, 242, 255, 0.3); }

        /* Theater Mode */
        .theater-dim #desktop { opacity: 0.15; }
        .theater-dim #dock { transform: translate(-50%, 100px); opacity: 0; }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 242, 255, 0.2); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="desktop">
        <div id="dock">
            <div onclick="Kernel.open('explorer')" class="dock-item" title="Explorer">
                <i class="material-icons-round text-yellow-400 text-3xl">folder_shared</i>
            </div>
            <div onclick="Kernel.open('cinema')" class="dock-item" title="Cinema">
                <i class="material-icons-round text-cyan-400 text-3xl">movie_filter</i>
            </div>
        </div>
    </div>

    <script>
        const Kernel = {
            token: null,
            playlist: [],
            z: 100,

            // Auth Logic
            connect() {
                const client = google.accounts.oauth2.initTokenClient({
                    client_id: '106130595767-hlvoakq65984eu1fc9mq0h3951oll8qs.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/drive.readonly',
                    callback: (res) => { 
                        this.token = res.access_token; 
                        alert("Titan Cloud Connected."); 
                    },
                });
                client.requestAccessToken();
            },

            // Window Management
            open(type) {
                if(document.getElementById('win-' + type)) return;
                const win = document.createElement('div');
                win.className = 'window';
                win.id = 'win-' + type;
                
                const isMobile = window.innerWidth < 768;
                win.style.width = isMobile ? '92vw' : (type === 'cinema' ? '900px' : '420px');
                win.style.height = isMobile ? '75vh' : '580px';
                win.style.top = '40px'; 
                win.style.left = isMobile ? '4vw' : '80px';
                win.style.zIndex = ++this.z;

                let ui = (type === 'explorer') ? this.getExplorerUI() : this.getCinemaUI();

                win.innerHTML = `
                    <div class="win-bar">
                        <span class="flex-grow text-[10px] font-black tracking-[4px] text-cyan-400 uppercase">${type} UNIT</span>
                        <div onclick="Kernel.close('${type}')" class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-500/20 cursor-pointer text-red-500 transition">
                            <i class="material-icons-round text-sm">close</i>
                        </div>
                    </div>
                    <div class="flex-grow overflow-hidden">
                        <iframe id="frame-${type}" srcdoc="${ui.replace(/"/g, '&quot;')}" class="w-full h-full border-none"></iframe>
                    </div>
                `;
                document.getElementById('desktop').appendChild(win);
                this.makeDraggable(win);
                if(type === 'cinema') setTimeout(() => this.sync(), 300);
            },

            close(type) {
                document.getElementById('win-' + type).remove();
                document.body.classList.remove('theater-dim');
            },

            getExplorerUI() {
                return `<html><head><script src="https://cdn.tailwindcss.com"></script></head>
                <body class="bg-[#0b0b12] text-white p-6 font-sans">
                    <button onclick="parent.Kernel.connect()" class="w-full bg-cyan-600 py-4 rounded-2xl font-black text-xs text-black mb-8 active:scale-95 transition tracking-widest uppercase">1. Link Cloud Drive</button>
                    <div class="p-4 border border-white/5 rounded-2xl bg-white/5">
                        <label class="text-[9px] text-cyan-500 font-bold tracking-widest uppercase mb-2 block">Series Identity</label>
                        <input id="show" placeholder="Enter Show Name..." class="w-full bg-black/40 border border-white/10 p-4 rounded-xl mb-4 text-sm outline-none focus:border-cyan-500">
                        <button onclick="parent.Kernel.pick(window)" class="w-full border border-cyan-500/30 py-4 rounded-xl font-bold text-xs text-cyan-400 hover:bg-cyan-500/10 active:scale-95 transition uppercase tracking-widest">2. Mount Season Folder</button>
                    </div>
                    <div id="status" class="mt-6 text-[10px] text-gray-500 font-mono text-center">SYSTEM: READY</div>
                </body></html>`;
            },

            getCinemaUI() {
                return `<html><head><script src="https://cdn.tailwindcss.com"></script></head>
                <body class="bg-black text-white h-screen flex flex-col overflow-hidden">
                    <div class="flex-grow flex items-center justify-center relative bg-black">
                        <iframe id="player" class="w-full h-full" style="display:none" allow="autoplay; fullscreen"></iframe>
                        <div id="empty" class="text-cyan-950 font-black text-5xl italic tracking-tighter opacity-50">TITAN</div>
                    </div>
                    <div id="list" class="h-32 bg-[#020205] p-4 flex gap-4 overflow-x-auto border-t border-white/5"></div>
                </body></html>`;
            },

            pick(child) {
                if(!this.token) return alert("Please link Cloud Drive first.");
                const name = child.document.getElementById('show').value || "Series";
                gapi.load('picker', () => {
                    new google.picker.PickerBuilder()
                        .setAppId('106130595767').setOAuthToken(this.token).setDeveloperKey('AIzaSyDQmlHngYNWqAbveDkUCiuIdgN1ZnnZ2ng')
                        .addView(new google.picker.DocsView(google.picker.ViewId.FOLDERS))
                        .setCallback(async (data) => {
                            if (data.action == google.picker.Action.PICKED) {
                                child.document.getElementById('status').innerText = "FETCHING DATA...";
                                const res = await fetch(`https://www.googleapis.com/drive/v3/files?q='${data.docs[0].id}'+in+parents&fields=files(id,name,mimeType)&key=AIzaSyDQmlHngYNWqAbveDkUCiuIdgN1ZnnZ2ng`, {
                                    headers: { 'Authorization': 'Bearer ' + this.token }
                                });
                                const json = await res.json();
                                // Auto-Sort Numeric logic
                                this.playlist = json.files.filter(f => f.mimeType.includes('video'))
                                    .sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true}))
                                    .map(f => ({ id: f.id, name: f.name, show: name }));
                                child.document.getElementById('status').innerText = "MOUNTED: " + this.playlist.length + " UNITS";
                                this.sync();
                            }
                        }).build().setVisible(true);
                });
            },

            sync() {
                const f = document.getElementById('frame-cinema')?.contentWindow;
                if(!f) return;
                const list = f.document.getElementById('list');
                list.innerHTML = "";
                this.playlist.forEach((ep, i) => {
                    const d = f.document.createElement('div');
                    d.className = "min-w-[160px] bg-white/5 border border-white/10 p-4 rounded-2xl cursor-pointer active:bg-cyan-500/20 transition-all";
                    d.innerHTML = `<div class='text-cyan-500 text-[10px] font-black mb-1'>EPISODE ${i+1}</div><div class='text-xs truncate font-medium'>${ep.name}</div>`;
                    d.onclick = () => {
                        document.body.classList.add('theater-dim');
                        f.document.getElementById('empty').style.display='none';
                        const p = f.document.getElementById('player');
                        p.src = `https://drive.google.com/file/d/${ep.id}/preview?autoplay=1`;
                        p.style.display='block';
                    };
                    list.appendChild(d);
                });
            },

            makeDraggable(el) {
                const bar = el.querySelector('.win-bar');
                let x = 0, y = 0, x1 = 0, y1 = 0;
                const onMove = (e) => {
                    const cx = e.touches ? e.touches[0].clientX : e.clientX;
                    const cy = e.touches ? e.touches[0].clientY : e.clientY;
                    x = x1 - cx; y = y1 - cy; x1 = cx; y1 = cy;
                    el.style.top = (el.offsetTop - y) + "px";
                    el.style.left = (el.offsetLeft - x) + "px";
                };
                const onEnd = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('touchmove', onMove);
                };
                const onStart = (e) => {
                    x1 = e.touches ? e.touches[0].clientX : e.clientX;
                    y1 = e.touches ? e.touches[0].clientY : e.clientY;
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('touchmove', onMove);
                    document.addEventListener('mouseup', onEnd);
                    document.addEventListener('touchend', onEnd);
                };
                bar.addEventListener('mousedown', onStart);
                bar.addEventListener('touchstart', onStart);
            }
        };
    </script>
</body>
</html>
